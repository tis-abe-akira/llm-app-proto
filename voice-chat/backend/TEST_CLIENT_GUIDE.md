# 🧪 Test Client 使用ガイド

WebSocketサーバーをテストするための`test_client.py`の詳細な使い方です。

## 📋 概要

`test_client.py`は、観光案内チャットボットのWebSocketサーバーと双方向通信してチャットボットの動作を確認するためのテストクライアントです。

## 🚀 基本的な使い方

### 1. サーバーを起動
```bash
# 別のターミナルでサーバーを起動
cd backend
uv run uvicorn app.main:app --reload
```

### 2. テストクライアントを実行
```bash
# インタラクティブモード（推奨）
uv run python test_client.py

# 自動テストモード
uv run python test_client.py test
```

## 📱 インタラクティブモード

### 起動時の画面
```
🎌 Tourism Chatbot WebSocket テストクライアント
============================================================
✅ 接続成功: ws://localhost:8000/ws/test-client
🔗 接続: 観光案内チャットボットに接続しました。音声で話しかけてください。

🎯 インタラクティブモード開始
   - 'quit' または 'exit' で終了
   - 'clear' で会話履歴クリア
   - 'history' で会話履歴表示
   - その他のテキストはチャットメッセージとして送信
--------------------------------------------------
💬 入力: 
```

### 実際のやり取り例

#### 基本的な挨拶
```bash
💬 入力: こんにちは
📤 送信: {"type": "chat", "data": "こんにちは"}
🤖 応答: こんにちは！観光案内チャットボットです。どのような旅行をお考えですか？
```

#### のんびり旅行の相談
```bash
💬 入力: のんびり温泉旅行がしたい
📤 送信: {"type": "chat", "data": "のんびり温泉旅行がしたい"}
🤖 応答: のんびりと過ごしたい気分ですね！箱根温泉でゆったり過ごす旅はいかがでしょうか。

📍 場所: 神奈川県箱根町
⏰ 期間: 1泊2日
💰 予算: 20,000円〜35,000円
✨ 見どころ: 温泉, 芦ノ湖, 大涌谷, 箱根神社

美しい自然に囲まれた箱根の温泉でリラックス。芦ノ湖の景色を眺めながら心身ともに癒される至福の時間を。

📍 おすすめ: 1件
🔊 音声合成開始: 音声を生成中...
📥 音声データ: 15234 bytes
🔊 音声合成完了: 音声の生成が完了しました
```

#### グルメ旅行の相談
```bash
💬 入力: 食事が美味しい旅行先を教えて
🤖 応答: グルメな旅行をお考えですね。大阪食べ歩きツアーをおすすめします。

📍 場所: 大阪府大阪市
⏰ 期間: 1泊2日
💰 予算: 20,000円〜35,000円
✨ 見どころ: たこ焼き, お好み焼き, 串かつ, 道頓堀, 新世界

たこ焼き、お好み焼き、串かつなど大阪グルメを食べ尽くし！道頓堀や新世界で本場の味を堪能。
```

## 🎮 特別なコマンド

| コマンド | 動作 | 使用例 |
|---------|------|-------|
| `quit` / `exit` / `q` | プログラムを終了 | `quit` |
| `clear` | 会話履歴をクリア | `clear` |
| `history` | 会話履歴を表示 | `history` |
| その他のテキスト | チャットメッセージとして送信 | `アクティブな旅行を教えて` |

### 会話履歴の操作例
```bash
💬 入力: history
📤 送信: {"type": "get_history", "data": ""}
📥 history: [{"role": "user", "content": "こんにちは"}, {"role": "assistant", "content": "..."}]

💬 入力: clear
📤 送信: {"type": "clear_history", "data": ""}
📥 system: 会話履歴をクリアしました
```

## 🧪 自動テストモード

```bash
uv run python test_client.py test
```

事前定義されたメッセージを順次送信して、各種旅行スタイルの応答を確認：

1. "こんにちは"
2. "のんびりできる温泉旅行を教えて"
3. "アクティブなスポーツ体験がしたい"
4. "美味しいグルメを楽しみたい"
5. "歴史的な場所を訪れたい"
6. "自然豊かな場所でリフレッシュしたい"
7. "家族で楽しめる場所を探している"

### 自動テスト実行例
```bash
🧪 自動テスト開始

🎯 テスト 1/7: こんにちは
📤 送信: {"type": "chat", "data": "こんにちは"}
🤖 応答: こんにちは！観光案内チャットボットです...

🎯 テスト 2/7: のんびりできる温泉旅行を教えて
📤 送信: {"type": "chat", "data": "のんびりできる温泉旅行を教えて"}
🤖 応答: のんびりと過ごしたい気分ですね！...
```

## 📊 受信メッセージの種類

| メッセージタイプ | 表示アイコン | 説明 |
|-----------------|-------------|------|
| `connection` | 🔗 | サーバー接続時の初期メッセージ |
| `transcript_partial` | 🎤 途中 | 音声認識の途中結果（リアルタイム） |
| `transcript_final` | 🎤 確定 | 音声認識の最終結果 |
| `chat_response` | 🤖 応答 | チャットボットの応答と観光プラン |
| `speech_synthesis_start` | 🔊 開始 | 音声合成処理開始の通知 |
| `speech_synthesis_complete` | 🔊 完了 | 音声合成処理完了の通知 |
| `audio` | 📥 音声 | 音声バイナリデータ（MP3形式） |
| `error` | ❌ | エラーメッセージ |
| `system` | 📥 | システムメッセージ |

## 🎯 テストできる旅行スタイル

現在のキーワードベースシステムで認識される旅行スタイル：

### のんびり系
- **キーワード**: のんびり、ゆっくり、リラックス、癒し、温泉
- **例**: "のんびり温泉旅行がしたい"
- **応答例**: 箱根温泉、由布院、京都寺巡り

### アクティブ系
- **キーワード**: アクティブ、運動、スポーツ、登山、ダイビング
- **例**: "アクティブなスポーツ体験がしたい"
- **応答例**: 北海道スキー、沖縄ダイビング、富士登山

### グルメ系
- **キーワード**: 食事、グルメ、美味しい、料理
- **例**: "美味しいグルメを楽しみたい"
- **応答例**: 大阪食べ歩き、福岡屋台、金沢海鮮

### 文化系
- **キーワード**: 文化、歴史、伝統、寺、神社
- **例**: "歴史的な場所を訪れたい"
- **応答例**: 奈良歴史探訪

### 自然系
- **キーワード**: 自然、山、海、森、景色
- **例**: "自然豊かな場所でリフレッシュしたい"
- **応答例**: 屋久島トレッキング

### ファミリー系
- **キーワード**: 家族、子供、ファミリー、テーマパーク
- **例**: "家族で楽しめる場所を探している"
- **応答例**: 東京ディズニーリゾート

## 🛠️ トラブルシューティング

### 接続エラー
```
❌ 接続失敗: Cannot connect to host localhost:8000
```
**原因**: サーバーが起動していない  
**解決法**: 
```bash
cd backend
uv run uvicorn app.main:app --reload
```

### 接続切断
```
🔌 接続が閉じられました
```
**原因**: サーバー停止またはネットワーク問題  
**解決法**: サーバーの状態確認、再起動

### JSON解析エラー
```
❌ 送信エラー: ...
```
**原因**: 不正なメッセージ形式  
**解決法**: 特殊文字を避ける、シンプルなテキストで試す

### AWS関連エラー（サーバー側）
サーバーログで以下のエラーが出る場合：
```
❌ エラー: AWS認証情報が無効です
```
**解決法**: `.env`ファイルのAWS認証情報を確認

## 💡 開発・デバッグ用途

### WebSocket通信の確認
- リアルタイム双方向通信の動作確認
- メッセージ形式の検証
- エラーハンドリングの確認

### 観光プラン提案の確認
- キーワード認識の精度確認
- 応答メッセージの内容確認
- 各旅行スタイルの動作確認

### 音声機能の確認
- 音声合成の動作確認（バイナリデータ受信）
- 音声データサイズの確認
- 音声生成タイミングの確認

## 📝 ログ出力

テストクライアントは以下の情報をリアルタイムで表示：
- 送信メッセージの内容
- 受信メッセージの種類と内容
- 音声データのサイズ
- エラー情報
- 接続状態の変化

これらの情報により、WebSocket通信とチャットボットの動作を詳細に確認できます。

## 🚀 次のステップ

テストクライアントで基本動作を確認したら：
1. フロントエンドのWebSocketクライアント実装
2. 実際の音声入力機能の実装
3. UI/UXの改善
4. より高度なテストシナリオの作成